---
import { getCollection } from "astro:content";
import { join } from "node:path/posix";
import NotionMarkdownFlummoxedLayout from "../../layouts/NotionMarkdownFlummoxedLayout.astro";
import { flummoxBlockMap } from "../../lib/notion/flummox";

export async function getStaticPaths() {
  const collection = await getCollection(
    "pages",
    (entry) => entry.data.properties.Type?.name === "page",
  );

  const paths = await Promise.all(
    collection.map(async (result) => {
      const fullPath = join("/", result.data.slug);
      return {
        params: { path: fullPath },
        props: {
          page: result.data.page,
          path: fullPath,
          blockMap: result.data.blockMap,
          properties: result.data.properties,
        },
      };
    }),
  );

  return paths;
}

const { page, blockMap: originalBlockMap } = Astro.props;
const blockMap = flummoxBlockMap(page.id, originalBlockMap);
---

<NotionMarkdownFlummoxedLayout page={page} blockMap={blockMap} />
