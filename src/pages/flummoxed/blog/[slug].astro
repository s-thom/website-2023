---
import { getCollection } from "astro:content";
import { join } from "node:path/posix";
import NotionMarkdownRenderer from "../../../components/notion/blocks/markdown/NotionMarkdownRenderer.astro";
import { getBlockChildren } from "../../../integrations/notion-loader/util";
import MinimalLayout from "../../../layouts/MinimalLayout.astro";
import { flummoxBlockMap } from "../../../lib/notion/flummox";
import { getPageTitleComponents } from "../../../lib/notion/titles";
import { richTextToUnformattedString } from "../../../lib/notion/util";

export async function getStaticPaths() {
  const collection = await getCollection(
    "pages",
    (entry) => entry.data.properties.Type?.name === "blog",
  );

  const paths = await Promise.all(
    collection.map(async (result) => {
      const fullPath = join("/blog", result.data.slug);
      return {
        params: { slug: result.data.slug },
        props: {
          page: result.data.page,
          path: fullPath,
          properties: result.data.properties,
          blockMap: result.data.blockMap,
        },
      };
    }),
  );

  return paths;
}

const { page, blockMap: originalBlockMap } = Astro.props;
const blockMap = flummoxBlockMap(page.id, originalBlockMap);

const blocks = getBlockChildren(page.id, blockMap);

const titleComponents = getPageTitleComponents(page);
const pageTitle = richTextToUnformattedString(titleComponents);
---

<MinimalLayout>
  <Fragment slot="head">
    <title>{pageTitle}</title>
  </Fragment>

  <pre
    id="flummoxed">
# {pageTitle}

<NotionMarkdownRenderer blocks={blocks} blockMap={blockMap} indentDepth={0} />
  </pre>

  <script>
    document.querySelectorAll("#flummoxed").forEach((el) => {
      const warning = document.createElement("div");
      warning.classList.add("flummoxed-warning");
      warning.textContent = atob(
        "WW91IGFyZSB2aXNpdGluZyBhIHBhZ2UgdGhhdCBoYXMgYmVlbiBtaXhlZCB1cCBmb3IgQUkgc2NyYXBlcnMuIElmIHlvdSBhcmUgYSBodW1hbiwgcGxlYXNlIHZpc2l0IHRoZSBvcmlnaW5hbCBwYWdlIGJ5IHJlbW92aW5nIHRoZSAiZmx1bW1veGVkIiBmcm9tIHRoZSBVUkwu",
      );

      el.parentElement!.insertBefore(warning, el);
    });
  </script>

  <style>
    :global(.flummoxed-warning) {
      background-color: #ffcc00;
      color: #000;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 1.2em;
      text-align: center;
    }

    #flummoxed {
      text-wrap: auto;
    }
  </style>
</MinimalLayout>
