---
import { getImageInfo } from "./image";

export interface Props {
  id: string;
  src: string;
  alt: string;
  class?: string;
  widths?: number[];
}

const { id, src, alt, class: className, widths, ...rest } = Astro.props;

const imageInfo = await getImageInfo(id, src, widths ?? []);
const formats = imageInfo.formats.slice();
const finalFormat = formats.at(-1)!.sizes[0];
---

<picture {...rest}>
  {
    formats.map((format) => {
      const srcset = format.sizes
        .map((size) => `${size.path} ${size.width}w`)
        .join(", ");

      return <source srcset={srcset} type={format.type} />;
    })
  }
  <img class={className} src={finalFormat.path} alt={alt} />
</picture>
