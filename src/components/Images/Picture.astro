---
import type { ImageFormatInfo } from "./constants";
import { getImageInfo, type ImageSourceData } from "./image";

// High-end phones now have densities even greater than 3.
// This isn't just for phones, higher densities will also provide clearer
// images for those who have zoomed in on desktop.
const DENSITIES = [1, 1.5, 2, 2.5, 3];

export interface ImageRequiredProps {
  alt: string;
  widths: number[];
  densities?: number[];
  noIntrinsicWidth?: boolean;
  sizes: string;
  loading: "eager" | "lazy";
  class?: string;
}

export interface Props extends ImageRequiredProps {
  id: string;
  getImage: () => Promise<ImageSourceData>;
}

const {
  id,
  getImage,
  alt,
  class: className,
  widths,
  densities,
  noIntrinsicWidth,
  sizes,
  loading,
  ...rest
} = Astro.props;

const imageInfo = await getImageInfo(
  id,
  getImage,
  widths ?? [],
  densities ?? DENSITIES,
);
const formats = noIntrinsicWidth
  ? imageInfo.formats.map<ImageFormatInfo>((format) => ({
      id: format.id,
      mimeType: format.mimeType,
      sizes: format.sizes.filter(
        (size) => size.width !== imageInfo.original.width,
      ),
    }))
  : imageInfo.formats.slice();
---

<picture {...rest}>
  {
    formats.map((format) => {
      const srcset = format.sizes
        .slice()
        .sort((a, z) => a.width - z.width)
        .map((size) => `${size.path} ${size.width}w`)
        .join(", ");

      return <source srcset={srcset} sizes={sizes} type={format.mimeType} />;
    })
  }
  <img
    class={className}
    src={imageInfo.original.path}
    alt={alt}
    loading={loading}
  />
</picture>
